package Ntt
import spinal.core._
import spinal.lib._

object tools {
  def wordCat(data: Seq[BigInt], n: Int, width: Int): Seq[BigInt] = {
    data.grouped(n).map { item =>
      {
        var ret = BigInt(0)
        item.zipWithIndex.foreach { case (t1, idx) =>
          ret = ret + (t1 << (width * (idx)))
        }
        ret
      }
    }.toSeq
  }
}

object NttCfg {

  case class NttCfg2414(nttPoint: Int = 1024, paraNum: Int = 4, debug: Boolean = true) {
    val M = 24
    val N = 14
    val useBramIP = false

    val AddSubLatencyIntt = 2 // add&sub + rescale
    val AddSubLatencyNtt = 1 // add&sub
    val MultLatency = 4
    val FastModLatency = 3
    val BfuLatencySt1 = AddSubLatencyIntt
    val BfuLatencySt2 = MultLatency + FastModLatency
    val BfuNttDelay = AddSubLatencyNtt + MultLatency + FastModLatency
    val BfuInttDelay = AddSubLatencyIntt + MultLatency + FastModLatency
    val BfuRegisterInput = 1
    val BfuRegisterOutput = 1
    val BfuRegisterIoDelay = BfuRegisterInput + BfuRegisterOutput

    val DecodeCalLatency = 1 // addrori -> bankidx & bankaddr
    val DecodeMuxRegLatency = 1 // mux -> register -> out
    val DecodeLatency = DecodeCalLatency + DecodeMuxRegLatency
    val ramLatency = 1
    val DatDeMuxLatency = 1 // addrdecode -> mem -> datademux -> bfu
    val addrNttLoopLatency = ramLatency + BfuNttDelay + BfuRegisterIoDelay
    val addrInttLoopLatency = ramLatency + BfuInttDelay + BfuRegisterIoDelay
    val bfuValidLoopNttLatency = addrNttLoopLatency + DecodeLatency + DatDeMuxLatency
    val bfuValidLoopInttLatency = addrInttLoopLatency + DecodeLatency + DatDeMuxLatency
    val bfuValidLoopLatency = if (bfuValidLoopInttLatency > bfuValidLoopNttLatency) {
      bfuValidLoopInttLatency
    } else {
      bfuValidLoopNttLatency
    }
    val width = M
    val useMulIP = true
    val radix = 2
    val Prime = BigInt(2).pow(M) - BigInt(2).pow(N) + 1
    val HalfPrime = (Prime + 1) / 2
    val delta = M - N
    val pGroup = scala.math.ceil((M.toDouble / delta)).toInt
    val BI = 2 * paraNum
    val Log2NttPoints = log2Up(nttPoint)
    val BankIndexWidth = log2Up(BI)
    val BankAddrWidth = Log2NttPoints - BankIndexWidth
    val twNum = nttPoint / paraNum
    val twAddrWidth = log2Up(nttPoint / paraNum)
    val twWidth = width * paraNum
//    val twInitSeq = (0 until nttPoint).map(B(_,width bits)).grouped(paraNum).map(item => Cat(item)).toSeq

    val tw128: Seq[BigInt] = Seq(7137274, 9791491, 9529539, 5336149, 496091, 8502265, 13549951, 9567998, 7228067, 5317357, 13789582, 104257, 13594383, 12943322, 6010615, 2368341, 14192771, 5002617, 15574480, 1529312, 11783397, 15916994, 10249503, 4473644, 1489794, 12437688, 16366294, 12296714, 15867241, 11000108, 9342819, 11741656, 5323229, 16536377, 13206029, 14088808, 4052540, 15227069, 8372956, 15191447, 9474305, 4494868, 15345349, 5630604, 15944390, 13774509, 2338668, 12065736, 7844650, 14992765, 11877402, 4029454, 7313684, 15366401, 5290368, 7595788, 4168418, 5267366, 2177119, 3399836, 14828815, 2175858, 11958274, 10714804, 6883526, 9115920, 13872692, 13579387, 4014377, 14469492, 1712825, 12679590, 3814112, 8869448, 8902879, 562011, 7183621, 8957841, 16209441, 6198172, 12067918, 11623086, 9964052, 16430732, 15488470, 11586795, 13066500, 12894074, 969506, 11411025, 9243904, 5662722, 12997781, 13372868, 2500857, 14922478, 6031454, 9880546, 15156583, 10621679, 15835724, 16114244, 11378168, 11055232, 640953, 12912026, 9504902, 15508953, 5128017, 12048975, 2060257, 9504357, 2547733, 16048733, 1618522, 10243994, 2515591, 10268196, 1676041, 9438321, 145829, 7803698, 11216936, 12061622, 10078830, 9080490, 10942343)
    val twCompress128 = tools.wordCat(tw128,paraNum,width)
    val tw: Seq[BigInt] = Seq(0, 7137274, 9791491, 9529539, 5336149, 496091, 8502265, 13549951, 9567998, 7228067,
      5317357, 13789582, 104257, 13594383, 12943322, 6010615, 2368341, 14192771, 5002617, 15574480, 1529312, 11783397,
      15916994, 10249503, 4473644, 1489794, 12437688, 16366294, 12296714, 15867241, 11000108, 9342819, 11741656,
      5323229, 16536377, 13206029, 14088808, 4052540, 15227069, 8372956, 15191447, 9474305, 4494868, 15345349, 5630604,
      15944390, 13774509, 2338668, 12065736, 7844650, 14992765, 11877402, 4029454, 7313684, 15366401, 5290368, 7595788,
      4168418, 5267366, 2177119, 3399836, 14828815, 2175858, 11958274, 10714804, 6883526, 9115920, 13872692, 13579387,
      4014377, 14469492, 1712825, 12679590, 3814112, 8869448, 8902879, 562011, 7183621, 8957841, 16209441, 6198172,
      12067918, 11623086, 9964052, 16430732, 15488470, 11586795, 13066500, 12894074, 969506, 11411025, 9243904, 5662722,
      12997781, 13372868, 2500857, 14922478, 6031454, 9880546, 15156583, 10621679, 15835724, 16114244, 11378168,
      11055232, 640953, 12912026, 9504902, 15508953, 5128017, 12048975, 2060257, 9504357, 2547733, 16048733, 1618522,
      10243994, 2515591, 10268196, 1676041, 9438321, 145829, 7803698, 11216936, 12061622, 10078830, 9080490, 10942343,
      11680345, 3744979, 13187237, 13517947, 4156796, 9129134, 11524787, 14775673, 4060236, 5882988, 6982524, 12221533,
      16167883, 13431701, 4158585, 5957574, 5806964, 7028730, 6024945, 6350965, 481224, 14405849, 11287859, 11923604,
      15040549, 9948334, 5797399, 5875729, 15357788, 10684850, 13713357, 12611173, 4235508, 8639728, 5980540, 6290192,
      5672345, 9091849, 7487635, 6737311, 1156437, 2565220, 9201926, 13512544, 451338, 8195843, 10171180, 12195386,
      3353390, 12755685, 15027494, 6306911, 4928483, 6879908, 9954541, 3898383, 16483819, 16562510, 8755683, 15480954,
      165683, 14678326, 2577283, 12141537, 3663036, 7943808, 10446644, 11768789, 5682931, 6439249, 11220089, 2983338,
      13668948, 762137, 6651550, 15138844, 1564347, 11310460, 74335, 1855008, 11747474, 13400020, 13359648, 11228367,
      1980141, 7446702, 3425823, 15790275, 2316585, 9438114, 380176, 9025854, 8807842, 13693757, 11599236, 8999100,
      979652, 11850203, 12254399, 15567758, 16074945, 16187497, 15234929, 8838545, 13651442, 7653508, 9849195, 11599959,
      11823095, 8852908, 12381118, 12482251, 14928474, 10719709, 6462583, 16592730, 9740886, 6969086, 9241198, 365980,
      8439881, 13377380, 16680232, 10649385, 3722271, 9117606, 790064, 5916847, 6147366, 16347029, 6654780, 5627656,
      14518413, 2621123, 5699281, 11949803, 15627185, 1648534, 8877577, 1799379, 5204808, 420514, 9477258, 9572427,
      12766851, 10448012, 7181758, 10797929, 5558327, 3348733, 6831261, 5519667, 2517803, 5462241, 5457897, 704991,
      5553678, 8611247, 8612030, 1574475, 14497757, 3376447, 5632996, 9014971, 2398844, 16001756, 13569363, 11975878,
      12380856, 2968926, 7889715, 5562637, 731609, 7220213, 13197318, 10121072, 9978158, 1200960, 3309954, 6489389,
      11883291, 13766323, 9520076, 13102470, 435543, 8315771, 5776926, 5407221, 14957628, 5064210, 13844374, 13204928,
      10828719, 14964072, 6898701, 5676133, 15862311, 15452599, 8491229, 5748354, 10962603, 13145292, 15848316, 7106816,
      10328402, 10918864, 13765294, 1867450, 13395219, 14864370, 16416641, 9158536, 15909010, 13086087, 9044365,
      8813132, 14922969, 7418891, 7143556, 1126992, 15980890, 8003910, 518109, 10353408, 909819, 11485882, 1245631,
      11384203, 3621084, 545672, 12311376, 7937377, 5493820, 2536492, 2352096, 3858502, 5445536, 5885989, 2817083,
      14745775, 5710632, 5280255, 4751841, 14384260, 13323866, 10102520, 5961257, 1435413, 5624716, 11083409, 1980188,
      7681920, 11811431, 10746483, 12746156, 1022978, 14192602, 14973162, 3374135, 10306093, 15059198, 15196307,
      14798356, 7136241, 10298933, 14284675, 6057110, 3639574, 15008641, 3247513, 829691, 12377603, 9238430, 5413655,
      6388959, 10807137, 6553150, 3040777, 14532742, 14778136, 15448573, 11061993, 6684804, 7892327, 9728165, 7138893,
      1434210, 6205450, 1283080, 10154378, 16288800, 15900789, 6343418, 15046272, 13083989, 11035673, 1221324, 286635,
      13542745, 16058601, 1863387, 492367, 13822040, 4849242, 15186547, 16690176, 12453847, 16284987, 5399984, 15419275,
      3346014, 13999114, 10948509, 2164369, 6512251, 2338979, 8502067, 8279671, 6037501, 1789258, 11436006, 3744244,
      11370208, 7169419, 45355, 9094541, 14803970, 640774, 3505420, 12954318, 2021329, 9238227, 1822087, 3846138,
      13861531, 12769048, 12255523, 9424727, 5618806, 49897, 12688191, 13337340, 2297714, 11994448, 3824161, 6943262,
      745395, 15589867, 12240155, 6689047, 8743792, 6253299, 11534734, 10351563, 7889548, 3657022, 860971, 12012763,
      10384584, 11078040, 9024917, 16327286, 7992832, 11668665, 3755721, 9627654, 2726361, 11474403, 3444588, 10920382,
      12523971, 15252750, 258830, 11898659, 9861765, 6395090, 13038610, 15015719, 16659013, 15719367, 4803258, 13162983,
      9232181, 5165042, 15536930, 12839186, 9538130, 12163162, 13613068, 10673085, 15527755, 12924767, 6496749,
      15336897, 574535, 8880808, 16527391, 4608923, 13358353, 3677520, 15564930, 338494, 14340749, 6793802, 2958873,
      6490528, 8075823, 13336979, 5286077, 14154422, 90996, 14627820, 2577616, 8815493, 6882394, 5373367, 6406667,
      4213476, 2318898, 8532371, 9482780, 120239, 15347391, 4654763, 1532591, 21142, 8459955, 15415172, 3925536,
      16456068, 3093594, 11713538, 9035372, 537607, 2863273, 16607558, 13141292, 400829, 11209537, 13651592, 5628717,
      6857251, 7668958, 4472384, 8442338, 1067447, 5817431, 9843007, 12870017, 14302973, 14259020, 11797955, 5146176,
      12249690, 6828862, 12770667, 15622435, 6762193, 10606902, 7499062, 876554, 7265717, 565205, 8903897, 8471317,
      3451473, 9293263, 14869180, 8485571, 16659592, 9749586, 2366621, 16177829, 1870317, 9888341, 4241853, 15523200,
      1896884, 11008193, 6655090, 10738478, 8750729, 10553464, 15366798, 15172492, 15889611, 16247605, 14430845,
      2806247, 9728173, 1362403, 12722806, 4899778, 15852330, 7613963, 12036781, 9316621, 7309421, 11531966, 15399238,
      1202907, 8324596, 13455245, 13221181, 10238403, 5560030, 6922593, 4711599, 15922414, 10272019, 106506, 8445595,
      6874159, 10163308, 12254671, 12649658, 1110700, 15808623, 8474986, 9688633, 550897, 12542974, 14415536, 16616722,
      2736616, 9661562, 7217356, 6010334, 2399830, 13804060, 13739681, 5274019, 4174348, 12096540, 6193237, 4130861,
      15189491, 10740250, 9970591, 13613361, 10122119, 957875, 10090505, 14272318, 6525848, 2630487, 5770977, 954184,
      4009397, 9283719, 14111675, 11866177, 1829074, 8501401, 9288842, 4868532, 9601800, 5933613, 1126888, 4817433,
      1095540, 5911798, 3408474, 3497020, 4015889, 763282, 6631678, 13398762, 135718, 14491996, 15691966, 13817223,
      9397718, 212177, 10853385, 7174724, 3622165, 5955686, 4066691, 1456741, 3896148, 11311918, 737030, 14380003,
      7017413, 8878238, 1914281, 4142547, 14488915, 135984, 15732852, 5538624, 9093038, 16325776, 41175, 9571961,
      15376479, 14003337, 14936111, 11852331, 3939858, 12173829, 15698818, 10307977, 3387453, 13837282, 2008727,
      3941157, 3927732, 1770084, 1059091, 4300765, 10820892, 15376863, 16187953, 3681230, 12318757, 8858652, 15589680,
      5451007, 9644101, 6876258, 14043416, 15813022, 13460944, 10004016, 13218748, 2540934, 13871510, 2086044, 14239270,
      9241985, 5137359, 3071914, 10303498, 12881133, 13091518, 12341021, 4277644, 5190473, 7396705, 10627084, 4264179,
      8412485, 1965675, 6372298, 5516700, 2569693, 13432404, 6607505, 673384, 7534965, 9107688, 6552789, 6175511,
      16340254, 16650628, 5850687, 7923718, 14189452, 286093, 2128591, 5493707, 544514, 16306106, 6225423, 9675994,
      7082967, 8288753, 14840023, 11891455, 5054918, 7569879, 6806841, 9495335, 5182091, 9226812, 405174, 4620092,
      1925000, 16250175, 4112890, 5250315, 4926558, 12292265, 7152917, 10061616, 570465, 14151452, 16224721, 13944805,
      6225111, 16200981, 15746251, 12221648, 9284002, 15909236, 309210, 9491375, 341489, 15606339, 3949271, 8880465,
      15182934, 8568666, 6366917, 12577912, 10615574, 8757403, 5901645, 13289865, 15750253, 1442822, 10434527, 7708562,
      14384168, 7773095, 16396370, 1319130, 13334695, 9231696, 13079583, 7605587, 16121068, 8151736, 14530583, 15285760,
      15382954, 13192093, 10717847, 742054, 3861959, 11616513, 10233617, 14196295, 8135735, 9258464, 6894648, 330221,
      2942760, 10369342, 2553902, 8563973, 16045202, 7073484, 4559151, 2760394, 16328609, 3308778, 10232498, 1099815,
      13042088, 7724304, 4727044, 15465581, 3104766, 14442525, 12251039, 7039662, 13955622, 3108210, 10685730, 8135537,
      14055091, 5018977, 8653609, 2943717, 8381966, 6048105, 10281759, 3889800, 8428165, 2116157, 3459726, 3836332,
      3307677, 5657986, 707445, 1335570, 7527422, 14745525, 6273548, 10524165, 8528380, 16314508, 3341097, 15615012,
      7770404, 7384376, 9549188, 13251739, 12165484, 5650221, 7849566, 14307276, 9734782, 12327716, 9118523, 11357627,
      907606, 7265029, 16363836, 10212955, 13358499, 6850977, 59983, 1110795, 6655500, 16022700, 7559118, 16171627,
      1856922, 8085183, 9541281, 6611444, 9133774, 15039910, 8176824, 825359, 682687, 8007676, 12138528, 11275914,
      2782312, 4234547, 4900111, 15945835, 16578864, 6448054, 1651722, 16097474, 8401641, 7326890, 4647031, 1893919,
      8152302, 1758331, 16420944, 4786420, 10915981, 9890416, 14269864, 5084546, 13354322, 4606755, 13633102, 11700443,
      9469017, 16541258, 4468616, 12455917, 7387461, 14635856, 16233175, 3785497, 1735838, 10212368, 13986911, 963505,
      13774633, 3067103, 384244, 3958662, 723461, 2676603, 3524315, 8512120, 6169120, 8580897, 11946947, 16152548,
      11574401, 607611, 5022827, 9117154, 5070650, 3490354, 3527929, 12269989, 10499131, 10737526, 2203246, 8077180,
      10856323, 13691043, 12914303, 812831, 3958070, 11965303, 549919, 1010105, 8772981, 6212112, 13362790, 4783674,
      5375354)
    val invTw: Seq[BigInt] = Seq(11385479, 11977159, 3398043, 10548721, 7987852, 15750728, 16210914, 4795530, 12802763,
      15948002, 3846530, 3069790, 5904510, 8683653, 14557587, 6023307, 6261702, 4490844, 13232904, 13270479, 11690183,
      7643679, 11738006, 16153222, 5186432, 608285, 4813886, 8179936, 10591713, 8248713, 13236518, 14084230, 16037372,
      12802171, 16376589, 13693730, 2986200, 15797328, 2773922, 6548465, 15024995, 12975336, 527658, 2124977, 9373372,
      4304916, 12292217, 219575, 7291816, 5060390, 3127731, 12154078, 3406511, 11676287, 2490969, 6870417, 5844852,
      11974413, 339889, 15002502, 8608531, 14866914, 12113802, 9433943, 8359192, 663359, 15109111, 10312779, 181969,
      814998, 11860722, 12526286, 13978521, 5484919, 4622305, 8753157, 16078146, 15935474, 8584009, 1720923, 7627059,
      10149389, 7219552, 8675650, 14903911, 589206, 9201715, 738133, 10105333, 15650038, 16700850, 9909856, 3402334,
      6547878, 396997, 9495804, 15853227, 5403206, 7642310, 4433117, 7026051, 2453557, 8911267, 11110612, 4595349,
      3509094, 7211645, 9376457, 8990429, 1145821, 13419736, 446325, 8232453, 6236668, 10487285, 2015308, 9233411,
      15425263, 16053388, 11102847, 13453156, 12924501, 13301107, 14644676, 8332668, 12871033, 6479074, 10712728,
      8378867, 13817116, 8107224, 11741856, 2705742, 8625296, 6075103, 13652623, 2805211, 9721171, 4509794, 2318308,
      13656067, 1295252, 12033789, 9036529, 3718745, 15661018, 6528335, 13452055, 432224, 14000439, 12201682, 9687349,
      715631, 8196860, 14206931, 6391491, 13818073, 16430612, 9866185, 7502369, 8625098, 2564538, 6527216, 5144320,
      12898874, 16018779, 6042986, 3568740, 1377879, 1475073, 2230250, 8609097, 639765, 9155246, 3681250, 7529137,
      3426138, 15441703, 364463, 8987738, 2376665, 9052271, 6326306, 15318011, 1010580, 3470968, 10859188, 8003430,
      6145259, 4182921, 10393916, 8192167, 1577899, 7880368, 12811562, 1154494, 16419344, 7269458, 16451623, 851597,
      7476831, 4539185, 1014582, 559852, 10535722, 2816028, 536112, 2609381, 16190368, 6699217, 9607916, 4468568,
      11834275, 11510518, 12647943, 510658, 14835833, 12140741, 16355659, 7534021, 11578742, 7265498, 9953992, 9190954,
      11705915, 4869378, 1920810, 8472080, 9677866, 7084839, 10535410, 454727, 16216319, 11267126, 14632242, 16474740,
      2571381, 8837115, 10910146, 110205, 420579, 10585322, 10208044, 7653145, 9225868, 16087449, 10153328, 3328429,
      14191140, 11244133, 10388535, 14795158, 8348348, 12496654, 6133749, 9364128, 11570360, 12483189, 4419812, 3669315,
      3879700, 6457335, 13688919, 11623474, 7518848, 2521563, 14674789, 2889323, 14219899, 3542085, 6756817, 3299889,
      947811, 2717417, 9884575, 7116732, 11309826, 1171153, 7902181, 4442076, 13079603, 572880, 1383970, 5939941,
      12460068, 15701742, 14990749, 12833101, 12819676, 14752106, 2923551, 13373380, 6452856, 1062015, 4587004,
      12820975, 4908502, 1824722, 2757496, 1384354, 7188872, 16719658, 435057, 7667795, 11222209, 1027981, 16624849,
      2271918, 12618286, 14846552, 7882595, 9743420, 2380830, 16023803, 5448915, 12864685, 15304092, 12694142, 10805147,
      13138668, 9586109, 5907448, 16548656, 7363115, 2943610, 1068867, 2268837, 16625115, 3362071, 10129155, 15997551,
      12744944, 13263813, 13352359, 10849035, 15665293, 11943400, 15633945, 10827220, 7159033, 11892301, 7471991,
      8259432, 14931759, 4894656, 2649158, 7477114, 12751436, 15806649, 10989856, 14130346, 10234985, 2488515, 6670328,
      15802958, 6638714, 3147472, 6790242, 6020583, 1571342, 12629972, 10567596, 4664293, 12586485, 11486814, 3021152,
      2956773, 14361003, 10750499, 9543477, 7099271, 14024217, 144111, 2345297, 4217859, 16209936, 7072200, 8285847,
      952210, 15650133, 4111175, 4506162, 6597525, 9886674, 8315238, 16654327, 6488814, 838419, 12049234, 9838240,
      11200803, 6522430, 3539652, 3305588, 8436237, 15557926, 1361595, 5228867, 9451412, 7444212, 4724052, 9146870,
      908503, 11861055, 4038027, 15398430, 7032660, 13954586, 2329988, 513228, 871222, 1588341, 1394035, 6207369,
      8010104, 6022355, 10105743, 5752640, 14863949, 1237633, 12518980, 6872492, 14890516, 583004, 14394212, 7011247,
      101241, 8275262, 1891653, 7467570, 13309360, 8289516, 7856936, 16195628, 9495116, 15884279, 9261771, 6153931,
      9998640, 1138398, 3990166, 9931971, 4511143, 11614657, 4962878, 2501813, 2457860, 3890816, 6917826, 10943402,
      15693386, 8318495, 12288449, 9091875, 9903582, 11132116, 3109241, 5551296, 16360004, 3619541, 153275, 13897560,
      16223226, 7725461, 5047295, 13667239, 304765, 12835297, 1345661, 8300878, 16739691, 15228242, 12106070, 1413442,
      16640594, 7278053, 8228462, 14441935, 12547357, 10354166, 11387466, 9878439, 7945340, 14183217, 2133013, 16669837,
      2606411, 11474756, 3423854, 8685010, 10270305, 13801960, 9967031, 2420084, 16422339, 1195903, 13083313, 3402480,
      12151910, 233442, 7880025, 16186298, 1423936, 10264084, 3836066, 1233078, 6087748, 3147765, 4597671, 7222703,
      3921647, 1223903, 11595791, 7528652, 3597850, 11957575, 1041466, 101820, 1745114, 3722223, 10365743, 6899068,
      4862174, 16502003, 1508083, 4236862, 5840451, 13316245, 5286430, 14034472, 7133179, 13005112, 5092168, 8768001,
      433547, 7735916, 5682793, 6376249, 4748070, 15899862, 13103811, 8871285, 6409270, 5226099, 10507534, 8017041,
      10071786, 4520678, 1170966, 16015438, 9817571, 12936672, 4766385, 14463119, 3423493, 4072642, 16710936, 11142027,
      7336106, 4505310, 3991785, 2899302, 12914695, 14938746, 7522606, 14739504, 3806515, 13255413, 16120059, 1956863,
      7666292, 16715478, 9591414, 5390625, 13016589, 5324827, 14971575, 10723332, 8481162, 8258766, 14421854, 10248582,
      14596464, 5812324, 2761719, 13414819, 1341558, 11360849, 475846, 4306986, 70657, 1574286, 11911591, 2938793,
      16268466, 14897446, 702232, 3218088, 16474198, 15539509, 5725160, 3676844, 1714561, 10417415, 860044, 472033,
      6606455, 15477753, 10555383, 15326623, 9621940, 7032668, 8868506, 10076029, 5698840, 1312260, 1982697, 2228091,
      13720056, 10207683, 5953696, 10371874, 11347178, 7522403, 4383230, 15931142, 13513320, 1752192, 13121259,
      10703723, 2476158, 6461900, 9624592, 1962477, 1564526, 1701635, 6454740, 13386698, 1787671, 2568231, 15737855,
      4014677, 6014350, 4949402, 9078913, 14780645, 5677424, 11136117, 15325420, 10799576, 6658313, 3436967, 2376573,
      12008992, 11480578, 11050201, 2015058, 13943750, 10874844, 11315297, 12902331, 14408737, 14224341, 11267013,
      8823456, 4449457, 16215161, 13139749, 5376630, 15515202, 5274951, 15851014, 6407425, 16242724, 8756923, 779943,
      15633841, 9617277, 9341942, 1837864, 7947701, 7716468, 3674746, 851823, 7602297, 344192, 1896463, 3365614,
      14893383, 2995539, 5841969, 6432431, 9654017, 912517, 3615541, 5798230, 11012479, 8269604, 1308234, 898522,
      11084700, 9862132, 1796761, 5932114, 3555905, 2916459, 11696623, 1803205, 11353612, 10983907, 8445062, 16325290,
      3658363, 7240757, 2994510, 4877542, 10271444, 13450879, 15559873, 6782675, 6639761, 3563515, 9540620, 16029224,
      11198196, 8871118, 13791907, 4379977, 4784955, 3191470, 759077, 14361989, 7745862, 11127837, 13384386, 2263076,
      15186358, 8148803, 8149586, 11207155, 16055842, 11302936, 11298592, 14243030, 11241166, 9929572, 13412100,
      11202506, 5962904, 9579075, 6312821, 3993982, 7188406, 7283575, 16340319, 11556025, 14961454, 7883256, 15112299,
      1133648, 4811030, 11061552, 14139710, 2242420, 11133177, 10106053, 413804, 10613467, 10843986, 15970769, 7643227,
      13038562, 6111448, 80601, 3383453, 8320952, 16394853, 7519635, 9791747, 7019947, 168103, 10298250, 6041124,
      1832359, 4278582, 4379715, 7907925, 4937738, 5160874, 6911638, 9107325, 3109391, 7922288, 1525904, 573336, 685888,
      1193075, 4506434, 4910630, 15781181, 7761733, 5161597, 3067076, 7952991, 7734979, 16380657, 7322719, 14444248,
      970558, 13335010, 9314131, 14780692, 5532466, 3401185, 3360813, 5013359, 14905825, 16686498, 5450373, 15196486,
      1621989, 10109283, 15998696, 3091885, 13777495, 5540744, 10321584, 11077902, 4992044, 6314189, 8817025, 13097797,
      4619296, 14183550, 2082507, 16595150, 1279879, 8005150, 198323, 277014, 12862450, 6806292, 9880925, 11832350,
      10453922, 1733339, 4005148, 13407443, 4565447, 6589653, 8564990, 16309495, 3248289, 7558907, 14195613, 15604396,
      10023522, 9273198, 7668984, 11088488, 10470641, 10780293, 8121105, 12525325, 4149660, 3047476, 6075983, 1403045,
      10885104, 10963434, 6812499, 1720284, 4837229, 5472974, 2354984, 16279609, 10409868, 10735888, 9732103, 10953869,
      10803259, 12602248, 3329132, 592950, 4539300, 9778309, 10877845, 12700597, 1985160, 5236046, 7631699, 12604037,
      3242886, 3573596, 13015854, 5080488, 5818490, 7680343, 6682003, 4699211, 5543897, 8957135, 16615004, 7322512,
      15084792, 6492637, 14245242, 6516839, 15142311, 712100, 14213100, 7256476, 14700576, 4711858, 11632816, 1251880,
      7255931, 3848807, 16119880, 5705601, 5382665, 646589, 925109, 6139154, 1604250, 6880287, 10729379, 1838355,
      14259976, 3387965, 3763052, 11098111, 7516929, 5349808, 15791327, 3866759, 3694333, 5174038, 1272363, 330101,
      6796781, 5137747, 4692915, 10562661, 551392, 7802992, 9577212, 16198822, 7857954, 7891385, 12946721, 4081243,
      15048008, 2291341, 12746456, 3181446, 2888141, 7644913, 9877307, 6046029, 4802559, 14584975, 1932018, 13360997,
      14583714, 11493467, 12592415, 9165045, 11470465, 1394432, 9447149, 12731379, 4883431, 1768068, 8916183, 4695097,
      14422165, 2986324, 816443, 11130229, 1415484, 12265965, 7286528, 1569386, 8387877, 1533764, 12708293, 2672025,
      3554804, 224456, 11437604, 5019177, 7418014, 5760725, 893592, 4464119, 394539, 4323145, 15271039, 12287189,
      6511330, 843839, 4977436, 15231521, 1186353, 11758216, 2568062, 14392492, 10750218, 3817511, 3166450, 16656576,
      2971251, 11443476, 9532766, 7192835, 3210882, 8258568, 16264742, 11424684, 7231294, 6969342, 9623559, 0)
    val twCompress = tools.wordCat(tw,paraNum,width)
    val invTwCompress = tools.wordCat(invTw,paraNum,width)
    def show(): Unit = {
      println(s"The prime is 2^$M - 2^$N + 1")
      println(s"group size is $pGroup")
    }

  }
//  case class NttCtrl(g:NttCfg2414) extends Bundle{
//    val isNtt
//  }
  class CtrlBus extends Bundle {
    val isNtt = Bool()
    val isCal = Bool()
    val isOutSideRead = Bool()
    val isOutSideWrite = Bool()
  }

  case class BfuPayload(g: NttCfg2414) extends Bundle {
    val A = UInt(g.width bits)
    val B = UInt(g.width bits)
    val Tw = UInt(g.width bits)
  }

  case class twPayload(addrWidth: Int, muxWidth: Int, para: Int) extends Bundle {
    val twAddr = UInt(addrWidth bits)
    val twMux = Vec(UInt(muxWidth bits), para)
  }

  case class ParaWriteBus(DataWidth: Int, AddrWidth: Int, para: Int) extends Bundle with IMasterSlave {
    val Addr = Vec(UInt(AddrWidth bits), para)
    val Data = Vec(Bits(DataWidth bits), para)

    override def asMaster(): Unit = {
      out(Addr, Data)
    }
  }
  case class DataPayload(g: NttCfg2414) extends Bundle {
    val A = UInt(g.width bits)
    val B = UInt(g.width bits)
  }

  case class multPayload(g: NttCfg2414) extends Bundle {
    val data = UInt(g.width bits)
    val tw = UInt(g.width bits)
  }

}

object test {
  def main(args: Array[String]): Unit = {
    val seq1 = Seq.range(0, 32).map(item => BigInt(item))
    val seq1Compress: Seq[BigInt] = seq1
      .grouped(4)
      .map { item =>
        val ret: BigInt = item(0) + (item(1) << 24) + (item(2) << 48) + (item(3) << 72)
        ret
      }
      .toSeq
    val seq2 = seq1.grouped(4).map { item =>
      {
        var ret = BigInt(0)
        item.zipWithIndex.foreach { case (t1, idx) =>
//          println(t1, idx)
          ret = ret + (t1 << (24 * (idx)))
        }
//        println(ret)
        ret
      }
    }
    val seq3 = tools.wordCat(seq1,4,24)
    println(seq1)
    println(seq2.toList)
    println(seq3.toList)

  }
}
